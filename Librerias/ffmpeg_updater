#!/bin/sh

# Script by www.seguridadwireless.net

SCRIPT_VERSION=20171007

############################################################
## Funciones comunes. Su nombre empieza por f_ ##
############################################################
f_variables(){
	. /opt/wifislax-updaters/Funciones/funciones_updater
}

############################################################
## Funciones propias del script. Su nombre empieza por F_ ##
############################################################
# Definicion de variables
F_variables() {
	PRGNAM=ffmpeg
	echo -ne "\033]2;${PRGNAM}_updater\007"
	WEB=http://ffmpeg.org/releases
	VERSION=3.3.4
	EXTENSION=tar.xz
	SOURCES=$PRGNAM-$VERSION.$EXTENSION
	CD=$PRGNAM-$VERSION
	DOWNLOAD=$WEB/$SOURCES
}

# Comprobar dependencias
F_dependencias(){
DEPENDENCIAS="SDL2
decklink-sdk
opencv
gavl
frei0r
ladspa_sdk
libiec61883
libavc1394
enca
libass
libaacs
libbdplus
libbluray
celt
libmp4v2
faac
libfdk-aac
flite
libgme
gsm
libilbc
libmodplug
lame
opencore-amr
opus
lua
libquvi-scripts
libquvi
rtmpdump
schroedinger
snappy
speex
libebur128
libbs2b
hdf5
netcdf
leptonica
tesseract
twolame
vid.stab
libwebp
x264
x265
xvidcore
zeromq
zvbi
OpenAL
libdc1394
libxml++
libconfig
libffado
jack-audio-connection-kit
opencl-headers
libclc
ocl-icd"
f_dependencias
}

# Descomprimimos el fichero descargado y compilamos
F_compilar(){

echo "ZGlmZiAtcnVwTiBmZm1wZWctMy4zLjMub3JpZy9jb25maWd1cmUgZmZtcGVnLTMuMy4zL2NvbmZp
Z3VyZQotLS0gZmZtcGVnLTMuMy4zLm9yaWcvY29uZmlndXJlCTIwMTctMDctMjkgMTk6NDk6Mjku
MDAwMDAwMDAwICswMjAwCisrKyBmZm1wZWctMy4zLjMvY29uZmlndXJlCTIwMTctMDgtMTUgMTM6
MjE6MjguNzgyNTY2NjE0ICswMjAwCkBAIC0xODc1LDYgKzE4NzUsNyBAQCBIRUFERVJTX0xJU1Q9
IgogICAgIG1hY2hpbmVfaW9jdGxfbWV0ZW9yX2gKICAgICBtYWxsb2NfaAogICAgIG9wZW5jdjJf
Y29yZV9jb3JlX2NfaAorICAgIG9wZW5qcGVnXzJfM19vcGVuanBlZ19oCiAgICAgb3BlbmpwZWdf
Ml8xX29wZW5qcGVnX2gKICAgICBvcGVuanBlZ18yXzBfb3BlbmpwZWdfaAogICAgIG9wZW5qcGVn
XzFfNV9vcGVuanBlZ19oCkBAIC01ODA1LDcgKzU4MDYsOSBAQCBlbmFibGVkIGxpYm9wZW5jdiAg
ICAgICAgICYmIHsgY2hlY2tfaGVhCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBy
ZXF1aXJlIG9wZW5jdiBvcGVuY3YyL2NvcmUvY29yZV9jLmggY3ZDcmVhdGVJbWFnZUhlYWRlciAt
bG9wZW5jdl9jb3JlIC1sb3BlbmN2X2ltZ3Byb2M7IH0gfHwKICAgICAgICAgICAgICAgICAgICAg
ICAgICAgICAgICByZXF1aXJlX3BrZ19jb25maWcgb3BlbmN2IG9wZW5jdi9jeGNvcmUuaCBjdkNy
ZWF0ZUltYWdlSGVhZGVyOyB9CiBlbmFibGVkIGxpYm9wZW5oMjY0ICAgICAgICYmIHJlcXVpcmVf
cGtnX2NvbmZpZyBvcGVuaDI2NCB3ZWxzL2NvZGVjX2FwaS5oIFdlbHNHZXRDb2RlY1ZlcnNpb24K
LWVuYWJsZWQgbGlib3BlbmpwZWcgICAgICAgJiYgeyB7IGNoZWNrX2xpYiBvcGVuanBlZy0yLjEv
b3BlbmpwZWcuaCBvcGpfdmVyc2lvbiAtbG9wZW5qcDIgLURPUEpfU1RBVElDICYmIGFkZF9jcHBm
bGFncyAtRE9QSl9TVEFUSUM7IH0gfHwKK2VuYWJsZWQgbGlib3BlbmpwZWcgICAgICAgJiYgeyB7
IGNoZWNrX2xpYiBvcGVuanBlZy0yLjMvb3BlbmpwZWcuaCBvcGpfdmVyc2lvbiAtbG9wZW5qcDIg
LURPUEpfU1RBVElDICYmIGFkZF9jcHBmbGFncyAtRE9QSl9TVEFUSUM7IH0gfHwKKyAgICAgICAg
ICAgICAgICAgICAgICAgICAgICAgICBjaGVja19saWIgb3BlbmpwZWctMi4zL29wZW5qcGVnLmgg
b3BqX3ZlcnNpb24gLWxvcGVuanAyIHx8CisgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAg
eyBjaGVja19saWIgb3BlbmpwZWctMi4xL29wZW5qcGVnLmggb3BqX3ZlcnNpb24gLWxvcGVuanAy
IC1ET1BKX1NUQVRJQyAmJiBhZGRfY3BwZmxhZ3MgLURPUEpfU1RBVElDOyB9IHx8CiAgICAgICAg
ICAgICAgICAgICAgICAgICAgICAgICAgY2hlY2tfbGliIG9wZW5qcGVnLTIuMS9vcGVuanBlZy5o
IG9wal92ZXJzaW9uIC1sb3BlbmpwMiB8fAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAg
IHsgY2hlY2tfbGliIG9wZW5qcGVnLTIuMC9vcGVuanBlZy5oIG9wal92ZXJzaW9uIC1sb3Blbmpw
MiAtRE9QSl9TVEFUSUMgJiYgYWRkX2NwcGZsYWdzIC1ET1BKX1NUQVRJQzsgfSB8fAogICAgICAg
ICAgICAgICAgICAgICAgICAgICAgICAgIHsgY2hlY2tfbGliIG9wZW5qcGVnLTEuNS9vcGVuanBl
Zy5oIG9wal92ZXJzaW9uIC1sb3BlbmpwZWcgLURPUEpfU1RBVElDICYmIGFkZF9jcHBmbGFncyAt
RE9QSl9TVEFUSUM7IH0gfHwKZGlmZiAtcnVwTiBmZm1wZWctMy4zLjMub3JpZy9saWJhdmNvZGVj
L2xpYm9wZW5qcGVnZGVjLmMgZmZtcGVnLTMuMy4zL2xpYmF2Y29kZWMvbGlib3BlbmpwZWdkZWMu
YwotLS0gZmZtcGVnLTMuMy4zLm9yaWcvbGliYXZjb2RlYy9saWJvcGVuanBlZ2RlYy5jCTIwMTct
MDctMjkgMTk6NDk6MzAuMDAwMDAwMDAwICswMjAwCisrKyBmZm1wZWctMy4zLjMvbGliYXZjb2Rl
Yy9saWJvcGVuanBlZ2RlYy5jCTIwMTctMDgtMTUgMTM6MjE6MjguODY5MjMzNDg0ICswMjAwCkBA
IC0zNCw3ICszNCw5IEBACiAjaW5jbHVkZSAiaW50ZXJuYWwuaCIKICNpbmNsdWRlICJ0aHJlYWQu
aCIKIAotI2lmIEhBVkVfT1BFTkpQRUdfMl8xX09QRU5KUEVHX0gKKyNpZiBIQVZFX09QRU5KUEVH
XzJfM19PUEVOSlBFR19ICisjICBpbmNsdWRlIDxvcGVuanBlZy0yLjMvb3BlbmpwZWcuaD4KKyNl
bGlmIEhBVkVfT1BFTkpQRUdfMl8xX09QRU5KUEVHX0gKICMgIGluY2x1ZGUgPG9wZW5qcGVnLTIu
MS9vcGVuanBlZy5oPgogI2VsaWYgSEFWRV9PUEVOSlBFR18yXzBfT1BFTkpQRUdfSAogIyAgaW5j
bHVkZSA8b3BlbmpwZWctMi4wL29wZW5qcGVnLmg+CkBAIC00NCw3ICs0Niw3IEBACiAjICBpbmNs
dWRlIDxvcGVuanBlZy5oPgogI2VuZGlmCiAKLSNpZiBIQVZFX09QRU5KUEVHXzJfMV9PUEVOSlBF
R19IIHx8IEhBVkVfT1BFTkpQRUdfMl8wX09QRU5KUEVHX0gKKyNpZiBIQVZFX09QRU5KUEVHXzJf
M19PUEVOSlBFR19IIHx8IEhBVkVfT1BFTkpQRUdfMl8xX09QRU5KUEVHX0ggfHwgSEFWRV9PUEVO
SlBFR18yXzBfT1BFTkpQRUdfSAogIyAgZGVmaW5lIE9QRU5KUEVHX01BSk9SX1ZFUlNJT04gMgog
IyAgZGVmaW5lIE9QSih4KSBPUEpfIyN4CiAjZWxzZQpAQCAtNDI5LDcgKzQzMSw3IEBAIHN0YXRp
YyBpbnQgbGlib3BlbmpwZWdfZGVjb2RlX2ZyYW1lKEFWQ28KICAgICBvcGpfc3RyZWFtX3NldF9y
ZWFkX2Z1bmN0aW9uKHN0cmVhbSwgc3RyZWFtX3JlYWQpOwogICAgIG9wal9zdHJlYW1fc2V0X3Nr
aXBfZnVuY3Rpb24oc3RyZWFtLCBzdHJlYW1fc2tpcCk7CiAgICAgb3BqX3N0cmVhbV9zZXRfc2Vl
a19mdW5jdGlvbihzdHJlYW0sIHN0cmVhbV9zZWVrKTsKLSNpZiBIQVZFX09QRU5KUEVHXzJfMV9P
UEVOSlBFR19ICisjaWYgSEFWRV9PUEVOSlBFR18yXzNfT1BFTkpQRUdfSCB8fCBIQVZFX09QRU5K
UEVHXzJfMV9PUEVOSlBFR19ICiAgICAgb3BqX3N0cmVhbV9zZXRfdXNlcl9kYXRhKHN0cmVhbSwg
JnJlYWRlciwgTlVMTCk7CiAjZWxpZiBIQVZFX09QRU5KUEVHXzJfMF9PUEVOSlBFR19ICiAgICAg
b3BqX3N0cmVhbV9zZXRfdXNlcl9kYXRhKHN0cmVhbSwgJnJlYWRlcik7CmRpZmYgLXJ1cE4gZmZt
cGVnLTMuMy4zLm9yaWcvbGliYXZjb2RlYy9saWJvcGVuanBlZ2VuYy5jIGZmbXBlZy0zLjMuMy9s
aWJhdmNvZGVjL2xpYm9wZW5qcGVnZW5jLmMKLS0tIGZmbXBlZy0zLjMuMy5vcmlnL2xpYmF2Y29k
ZWMvbGlib3BlbmpwZWdlbmMuYwkyMDE3LTA3LTI5IDE5OjQ5OjMwLjAwMDAwMDAwMCArMDIwMAor
KysgZmZtcGVnLTMuMy4zL2xpYmF2Y29kZWMvbGlib3BlbmpwZWdlbmMuYwkyMDE3LTA4LTE1IDEz
OjIxOjI4Ljg2OTIzMzQ4NCArMDIwMApAQCAtMzIsNyArMzIsOSBAQAogI2luY2x1ZGUgImF2Y29k
ZWMuaCIKICNpbmNsdWRlICJpbnRlcm5hbC5oIgogCi0jaWYgSEFWRV9PUEVOSlBFR18yXzFfT1BF
TkpQRUdfSAorI2lmIEhBVkVfT1BFTkpQRUdfMl8zX09QRU5KUEVHX0gKKyMgIGluY2x1ZGUgPG9w
ZW5qcGVnLTIuMy9vcGVuanBlZy5oPgorI2VsaWYgSEFWRV9PUEVOSlBFR18yXzFfT1BFTkpQRUdf
SAogIyAgaW5jbHVkZSA8b3BlbmpwZWctMi4xL29wZW5qcGVnLmg+CiAjZWxpZiBIQVZFX09QRU5K
UEVHXzJfMF9PUEVOSlBFR19ICiAjICBpbmNsdWRlIDxvcGVuanBlZy0yLjAvb3BlbmpwZWcuaD4K
QEAgLTQyLDcgKzQ0LDcgQEAKICMgIGluY2x1ZGUgPG9wZW5qcGVnLmg+CiAjZW5kaWYKIAotI2lm
IEhBVkVfT1BFTkpQRUdfMl8xX09QRU5KUEVHX0ggfHwgSEFWRV9PUEVOSlBFR18yXzBfT1BFTkpQ
RUdfSAorI2lmIEhBVkVfT1BFTkpQRUdfMl8zX09QRU5KUEVHX0ggfHwgSEFWRV9PUEVOSlBFR18y
XzFfT1BFTkpQRUdfSCB8fCBIQVZFX09QRU5KUEVHXzJfMF9PUEVOSlBFR19ICiAjICBkZWZpbmUg
T1BFTkpQRUdfTUFKT1JfVkVSU0lPTiAyCiAjICBkZWZpbmUgT1BKKHgpIE9QSl8jI3gKICNlbHNl
CkBAIC0zMDUsNyArMzA3LDcgQEAgc3RhdGljIGF2X2NvbGQgaW50IGxpYm9wZW5qcGVnX2VuY29k
ZV9pbgogCiAgICAgb3BqX3NldF9kZWZhdWx0X2VuY29kZXJfcGFyYW1ldGVycygmY3R4LT5lbmNf
cGFyYW1zKTsKIAotI2lmIEhBVkVfT1BFTkpQRUdfMl8xX09QRU5KUEVHX0gKKyNpZiBIQVZFX09Q
RU5KUEVHXzJfM19PUEVOSlBFR19IIHx8IEhBVkVfT1BFTkpQRUdfMl8xX09QRU5KUEVHX0gKICAg
ICBzd2l0Y2ggKGN0eC0+Y2luZW1hX21vZGUpIHsKICAgICBjYXNlIE9QSl9DSU5FTUEyS18yNDoK
ICAgICAgICAgY3R4LT5lbmNfcGFyYW1zLnJzaXogPSBPUEpfUFJPRklMRV9DSU5FTUFfMks7CkBA
IC03NjksNyArNzcxLDcgQEAgc3RhdGljIGludCBsaWJvcGVuanBlZ19lbmNvZGVfZnJhbWUoQVZD
bwogICAgIG9wal9zdHJlYW1fc2V0X3dyaXRlX2Z1bmN0aW9uKHN0cmVhbSwgc3RyZWFtX3dyaXRl
KTsKICAgICBvcGpfc3RyZWFtX3NldF9za2lwX2Z1bmN0aW9uKHN0cmVhbSwgc3RyZWFtX3NraXAp
OwogICAgIG9wal9zdHJlYW1fc2V0X3NlZWtfZnVuY3Rpb24oc3RyZWFtLCBzdHJlYW1fc2Vlayk7
Ci0jaWYgSEFWRV9PUEVOSlBFR18yXzFfT1BFTkpQRUdfSAorI2lmIEhBVkVfT1BFTkpQRUdfMl8z
X09QRU5KUEVHX0ggfHwgSEFWRV9PUEVOSlBFR18yXzFfT1BFTkpQRUdfSAogICAgIG9wal9zdHJl
YW1fc2V0X3VzZXJfZGF0YShzdHJlYW0sICZ3cml0ZXIsIE5VTEwpOwogI2VsaWYgSEFWRV9PUEVO
SlBFR18yXzBfT1BFTkpQRUdfSAogICAgIG9wal9zdHJlYW1fc2V0X3VzZXJfZGF0YShzdHJlYW0s
ICZ3cml0ZXIpOwo=
" | base64 -d > $TMP/ffmpeg-openjpeg2.2.patch

patch -p1 -i $TMP/ffmpeg-openjpeg2.2.patch || exit 1


# Fix linking with flite
sed -i "s| -lflite\"| -lflite -lm -lasound\"|" \
  ./configure

CFLAGS="$SLKCFLAGS" \
CXXFLAGS="$SLKCFLAGS" \
./configure \
  --prefix=/usr \
  --libdir=/usr/lib${LIBDIRSUFFIX} \
  --shlibdir=/usr/lib${LIBDIRSUFFIX} \
  --docdir=/usr/doc/$PRGNAM-$VERSION/html \
  --mandir=/usr/man \
  --disable-debug \
  --enable-shared \
  --disable-static \
  --enable-pthreads \
  --enable-libtheora \
  --enable-libvorbis \
  --enable-gpl \
  --enable-version3 \
  --enable-postproc \
  --enable-swscale \
  --enable-avfilter \
  --enable-avresample \
  --enable-gnutls \
  --enable-libcdio \
  --enable-libssh \
  --enable-libcaca \
  --enable-libsmbclient \
  --enable-opengl \
  --enable-libvpx \
  --enable-libpulse \
  --enable-libopenjpeg \
  --enable-libwavpack \
  --enable-libfreetype \
  --enable-libfribidi \
  --enable-fontconfig \
  --enable-libdc1394 \
  --enable-libmp3lame \
  --enable-libxvid \
  --enable-libx264 \
  --enable-libspeex \
  --enable-libschroedinger \
  --enable-nonfree \
  --enable-libgsm \
  --enable-librtmp \
  --enable-libopencore-amrnb \
  --enable-libopencore-amrwb \
  --enable-frei0r \
  --enable-libcelt \
  --enable-libbluray \
  --enable-libass \
  --enable-openal \
  --enable-libiec61883 \
  --enable-libilbc \
  --enable-libmodplug \
  --enable-libopus \
  --enable-libtwolame \
  --enable-ladspa \
  --enable-libfdk-aac \
  --enable-libflite \
  --enable-libvidstab \
  --enable-libx265 \
  --enable-libzvbi \
  --enable-libopencv \
  --enable-libgme \
  --enable-libsnappy \
  --enable-libwebp \
  --enable-openssl \
  --enable-libzmq \
  --enable-opencl \
  --enable-libbs2b \
  --enable-libtesseract \
  --enable-netcdf \
  --arch=$ARCH
  
  make || exit 1
  make install DESTDIR=$PKG
  make install-man DESTDIR=$PKG
}

###################################
## BLOQUE PRINCIPAL DE EJECUCION ##
###################################
# Si se cierra el script inesperadamente, ejecutar la funcion de limpieza
trap f_exitmode SIGHUP SIGINT

#Inicializamos las variables globales
f_variables
#Comprobamos conexion a Internet
f_comprobarConexion
#Inicializamos las variables del script
F_variables
#Creamos directorio de trabajo
f_directorioTemporal
#Mostramos el mensaje de presentacion
f_presentacion
#Comprobamos updates del script
f_comprobarUpdates
#Asignamos o detectamos arquitectura
f_arquitectura
#Comprobamos version instalada del script
f_versionInstalada
#Compronar dependencias
F_dependencias
#Si no existe el fichero se descargara
f_download
#Preparamos entorno
f_preparar
#Descomprimir fichero descargado y compilamos
F_compilar
#Hacemos strip sobre el paquete
f_strip
#Creamos xzm , instalamos y salimos
f_tareasFinales